parameters:
- name: buildRelease
  default: true
- name: buildDebug
  default: true
- name: publishBinariesAsArtifacts
  default: false

jobs:
- job: buildprep
  displayName: Prepare Build Jobs
  pool:
    vmImage: 'windows-2019'
  variables:
    skipComponentGovernanceDetection: true
    DOTNET_CLI_TELEMETRY_OPTOUT: true
    DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  steps:
  - task: PowerShell@2
    name: buildmatrix
    displayName: Prepare Solutions
    inputs:
      targetType: filePath
      filePath: ./tools/scripts/get-matrix.ps1
      arguments: -FileName *.sln
- job: buildall
  displayName: Building
  dependsOn: buildprep
  strategy:
    matrix: $[dependencies.buildprep.outputs['buildmatrix.jobMatrix'] ]
  pool:
    vmImage: $(poolImage)
  steps:
  - task: UseDotNet@2
    displayName: 'Install .NET Core SDK'
    inputs:
      packageType: sdk
      version: 3.1.x
      includePreviewVersions: false
      installationPath: $(Agent.ToolsDirectory)/dotnet
  - task: PowerShell@2
    displayName: Versioning
    inputs:
      targetType: filePath
      filePath: ./tools/scripts/set-version.ps1
  - task: DotNetCoreCLI@2
    displayName: Release Build
    condition: eq(${{parameters.buildRelease}}, true)
    inputs:
      command: build
      projects: '$(file)'
      arguments: '--configuration Release'
  - task: DotNetCoreCLI@2
    displayName: Debug Build
    condition: eq(${{parameters.buildDebug}}, true)
    inputs:
      command: build
      projects: '$(file)'
      arguments: '--configuration Debug'
  - task: PowerShell@2
    displayName: TESTING 
    inputs:
      targetType: 'inline'
      script: |
        Write-Host "1: $(file)"
        dir $(file)
        Write-Host "2: $(System.DefaultWorkingDirectory)"
        dir $(System.DefaultWorkingDirectory)

  # - task: PublishPipelineArtifact@1
  #   condition: eq(${{parameters.publishBinariesAsArtifacts}}, true)
  #   inputs:
  #     targetPath: $(System.DefaultWorkingDirectory)/deploy/src/Microsoft.Azure.IIoT.Deployment/bin/Debug/netcoreapp3.1
  #     artifactName: WebApp