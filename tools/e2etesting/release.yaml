# Starter pipeline

# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

pool:
  name: 'Azure-IoT-Manufacturing'

variables:
- name: IAIBlobUrl
  value: https://azureiiot.blob.core.windows.net/binaries/master/
- name: IAIVersion
  value: 2.7.160
- name: Region
  value: EastUS

steps:
- task: PowerShell@2
  inputs:
    targetType: 'filePath'
    filePath: $(System.DefaultWorkingDirectory)\tools\e2etesting\DownloadIAIBinaries.ps1
    workingDirectory: 
    arguments: > # Use this to avoid newline characters in multiline string
      -IAIBlobUrl "$(IAIBlobUrl)"
      -IAIVersion "$(IAIVersion)"

- task: AzureKeyVault@1
  inputs:
    azureSubscription: 'IOT-OPC-WALLS-MSI'
    KeyVaultName: 'automatedtesting'
    SecretsFilter: '*'

- task: AzurePowerShell@4
  inputs:
    azureSubscription: 'IOT-OPC-WALLS-MSI'
    azurePowerShellVersion: 'latestVersion'
    scriptType: filePath
    scriptPath: '$(System.DefaultWorkingDirectory)\tools\e2etesting\ReplaceVariablesInAppSettings.ps1'
    scriptArguments: > # Use this to avoid newline characters in multiline string
      -ClientId "$(IAIClientId)"
      -ClientSecret "$(IAIClientSecret)"
      -ApplicationName "Deployment_$(Build.BuildNumber)"
      -AppSettingsFilename "$(System.DefaultWorkingDirectory)\tools\e2etesting\appsettings.json"
      -ResourceGroupName "Deployment_$(Build.BuildNumber)"
      -Region "$(Region)"
