pr:
  autoCancel: 'true'
  drafts: 'true'
  branches:
    include:
    - '*'
variables:
  system_accesstoken: $(System.AccessToken)
jobs:
- job: OneBranchTrigger
  pool:
    vmImage: 'ubuntu-latest'
  displayName: Trigger Pull Request Build on Governed Pipeline
  steps:
  - task: TriggerBuild@4
    inputs:
      definitionIsInCurrentTeamProject: true
      buildDefinition: 'Industrial-IoT-PullRequest'
      queueBuildForUserThatTriggeredBuild: false
      ignoreSslCertificateErrors: false
      useSameSourceVersion: false
      useCustomSourceVersion: false
      useSameBranch: false
      branchToUse: 'main'
      # waitForQueuedBuildsToFinish: true
      # waitForQueuedBuildsToFinishRefreshTime: '60'
      # failTaskIfBuildsNotSuccessful: true
      # cancelBuildsIfAnyFails: false
      # treatPartiallySucceededBuildAsSuccessful: false
      # downloadBuildArtifacts: true
      storeInEnvironmentVariable: true
      authenticationMethod: 'OAuth Token'
      enableBuildInQueueCondition: true
      dependentOnSuccessfulBuildCondition: false
      dependentOnFailedBuildCondition: false
      checkbuildsoncurrentbranch: false
      failTaskIfConditionsAreNotFulfilled: false
      templateParameters: 'ref: $(Build.SourceBranch)'
  - task: PowerShell@2
    inputs:
      targetType: 'inline'
      script: |
        $buildId = $env:TriggeredBuildIds
        $buildUrl = "$(System.TeamFoundationCollectionUri)$(System.TeamProject)/_build/results?buildId=$buildId&view=results"
        Write-Host "##vso[build.addbuildtag]$($buildId)"
        #Write-Host "##vso[build.addbuildtag]$($buildUrl)"
        Write-Host "##vso[build.updatebuildnumber]$($buildUrl)"
  - task: WaitForBuildToFinish@3
    inputs:
      definitionIsInCurrentTeamProject: true
      ignoreSslCertificateErrors: false
      waitForQueuedBuildsToFinishRefreshTime: '60'
      failTaskIfBuildsNotSuccessful: true
      cancelBuildsIfAnyFails: false
      treatPartiallySucceededBuildAsSuccessful: false
      downloadBuildArtifacts: true
      clearVariable: true
      authenticationMethod: 'OAuth Token'