stages:
- stage: iai_publish
  displayName: 'Sign and Publish IAI'
  # dependsOn:
  # - build
  jobs:
  - template: tools/templates/iai_publish.yml
    parameters:
      # sign: ${{ startsWith(variables['Build.SourceBranch'], 'refs/heads/') }}
      sign: 'True'
- stage: build
  displayName: 'Build and Test Code'
  # Delete dependsOn after fixing iai_publish job
  dependsOn:
  - iai_publish
  jobs:
  - template: tools/templates/ci.yml
  - template: tools/templates/sdl.yml
- stage: pack
  displayName: 'Package and Sign Nuget'
  dependsOn: build
  jobs:
  - template: tools/templates/nuget.yml
    parameters:
      sign: ${{ startsWith(variables['Build.SourceBranch'], 'refs/heads/') }}
- stage: images
  displayName: 'Create and Push Images'
  dependsOn: pack
  # dependsOn:
  # - pack
  # - iai_publish
  jobs:
  - template: tools/templates/acrbuild.yml
    parameters:
      useNugets: ${{ startsWith(variables['Build.SourceBranch'], 'refs/heads/') }}
