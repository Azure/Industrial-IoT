{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "appInsightsId": {
      "type": "string",
      "metadata": {
        "description": "The id of the Application Insights resource"
      }
    },
    "workbookDisplayName": {
      "type": "string",
      "defaultValue": "Industrial Iot Monitoring",
      "metadata": {
        "description": "The friendly name for the workbook that is used in the Gallery or Saved List.  This name must be unique within a resource group."
      }
    },
    "workbookType": {
      "type": "string",
      "defaultValue": "workbook",
      "metadata": {
        "description": "The gallery that the workbook will been shown under. Supported values include workbook, tsg, etc. Usually, this is 'workbook'"
      }
    },
    "workbookSourceId": {
      "type": "string",
      "metadata": {
        "description": "The id of resource instance to which the workbook will be associated"
      }
    },
    "workbookId": {
      "type": "string",
      "metadata": {
        "description": "The unique guid for this workbook instance"
      }
    },
    "tags": {
      "type": "object",
      "defaultValue": {},
      "metadata": {
          "description": "Tags for Azure resources."
      }
    }
  },
  "variables": {
    "workbookDataTemplate":"{\"version\":\"Notebook\\/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Industrial IoT Diagnostics\\r\\n\"},\"name\":\"text - 7\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem\\/1.0\",\"parameters\":[{\"id\":\"12e24ac4-d5f3-42ec-9c32-118fd5438150\",\"version\":\"KqlParameterItem\\/1.0\",\"name\":\"TimeRange\",\"type\":4,\"isRequired\":true,\"value\":{\"durationMs\":172800000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000},{\"durationMs\":900000},{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}]}}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights\\/workspaces\"},\"name\":\"parameters - 6\"},{\"type\":11,\"content\":{\"version\":\"LinkItem\\/1.0\",\"style\":\"tabs\",\"links\":[{\"id\":\"409116c9-da9a-4ade-a06e-9c028e4d8c93\",\"cellValue\":\"selectedTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Overview\",\"subTarget\":\"Overview\",\"style\":\"link\"},{\"id\":\"5fb68de8-8bf5-487f-9414-aa9dad57a65c\",\"cellValue\":\"selectedTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Edge Modules\",\"subTarget\":\"Edge\",\"style\":\"link\"},{\"id\":\"14c69930-bc47-4990-a951-fb2823561e63\",\"cellValue\":\"selectedTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Services (AKS only)\",\"subTarget\":\"Service\",\"style\":\"link\"},{\"id\":\"89660d25-69c2-4348-9bac-eda4d2b57ad7\",\"cellValue\":\"selectedTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"App Insights\",\"subTarget\":\"AppInsights\",\"style\":\"link\"}]},\"name\":\"links - 5\"},{\"type\":3,\"content\":{\"version\":\"KqlItem\\/1.0\",\"query\":\"InsightsMetrics\\r\\n| where Name == \\\"iiot_edge_publisher_messages\\\"\\r\\n| extend guid_ = tostring(parse_json(Tags).runid)\\r\\n| summarize msg_sent = max(tolong(Val)) by guid_\\r\\n| summarize messages = sum(msg_sent)\",\"size\":4,\"showAnalytics\":true,\"title\":\"Messages sent from Publisher to IotHub\",\"timeContextFromParameter\":\"TimeRange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights\\/workspaces\",\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"messages\",\"formatter\":12,\"formatOptions\":{\"palette\":\"gray\",\"linkColumn\":\"messages\",\"linkIsContextBlade\":true},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"useGrouping\":false}}},\"showBorder\":false,\"size\":\"auto\"}},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Overview\"},\"showPin\":true,\"name\":\"query - 0\"},{\"type\":3,\"content\":{\"version\":\"KqlItem\\/1.0\",\"query\":\"let max_timestamp = InsightsMetrics\\r\\n| where Name == \\\"iiot_edge_publisher_exceptions\\\"\\r\\n| order by TimeGenerated desc\\r\\n| project timestamp = TimeGenerated \\r\\n| limit 1;\\r\\nlet publisher_exceptions = InsightsMetrics\\r\\n| where Name == \\\"iiot_edge_publisher_exceptions\\\" and TimeGenerated == toscalar(max_timestamp)\\r\\n| extend type_ = tostring(parse_json(Tags).type) \\r\\n| extend source_ = tostring(parse_json(Tags).source) \\r\\n| extend stacktrace_ = tostring(parse_json(Tags).stacktrace) \\r\\n| project TimeGenerated, type_ , source_ , count_of_exceptions = tolong(Val), stacktrace_;\\r\\npublisher_exceptions\\r\\n| summarize sum(count_of_exceptions) \",\"size\":4,\"showAnalytics\":true,\"title\":\"Exception Count\",\"timeContextFromParameter\":\"TimeRange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights\\/workspaces\",\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"sum_count_of_exceptions\",\"formatter\":12,\"formatOptions\":{\"palette\":\"coldHot\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"useGrouping\":false}}},\"showBorder\":false,\"size\":\"auto\"}},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Overview\"},\"showPin\":true,\"name\":\"query - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem\\/1.0\",\"query\":\"let uptime_table = InsightsMetrics\\r\\n| where Name startswith \\\"iiot_edge_module_start\\\"\\r\\n| extend module_ = tostring(parse_json(Tags).module)\\r\\n| extend device_ = tostring(parse_json(Tags).deviceid)\\r\\n| extend guid_ = tostring(parse_json(Tags).guid)\\r\\n| extend version_ = tostring(parse_json(Tags).version)\\r\\n| extend start_time_utc = tostring(parse_json(Tags).timestamp_utc)\\r\\n| extend agent = strcat(module_, device_)\\r\\n| where isnotempty( device_)\\r\\n| summarize count(Val) by agent, module_, device_, guid_, version_, start_time_utc\\r\\n| sort by agent, start_time_utc asc\\r\\n| extend rn=row_number(1, prev(agent) != agent)\\r\\n| partition by agent (top 1 by start_time_utc desc)\\r\\n| extend up_since_hrs = now() - todatetime(start_time_utc)\\r\\n| project module = module_ , device = device_ , version = version_, up_since_hrs, restarts = rn ;\\r\\nuptime_table\",\"size\":0,\"showAnalytics\":true,\"title\":\"Module Uptime\",\"timeContextFromParameter\":\"TimeRange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights\\/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Count\",\"formatter\":4,\"formatOptions\":{\"showIcon\":true,\"aggregation\":\"Count\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}}],\"filter\":true},\"sortBy\":[],\"tileSettings\":{\"showBorder\":false},\"graphSettings\":{\"type\":0},\"mapSettings\":{\"locInfo\":\"LatLong\"}},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Overview\"},\"showPin\":true,\"name\":\"query - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem\\/1.0\",\"query\":\"\\r\\nlet max_records_sent = InsightsMetrics\\r\\n| where Name == \\\"iiot_edge_publisher_messages_duration_count\\\"\\r\\n| order by TimeGenerated desc\\r\\n| project message_count = Val\\r\\n| limit 1;\\r\\nlet aggregated_publisher_data = InsightsMetrics\\r\\n| where Name startswith \\\"iiot_edge_publisher_messages_duration_\\\"\\r\\n| extend time_taken_less_than = tostring(parse_json(Tags).le) \\r\\n| summarize arg_max(TimeGenerated, *) by Name , time_taken_less_than\\r\\n| extend total_messages = toscalar(max_records_sent)\\r\\n| where time_taken_less_than != \\\"\\\" and time_taken_less_than != \\\"+Inf\\\"\\r\\n| extend less_than_millisec_taken = todouble(time_taken_less_than) * 1000\\r\\n| extend percent_of_messages = todouble(Val) * 100 \\/ toint(total_messages)\\r\\n| where percent_of_messages < 99.99 and percent_of_messages > 50\\r\\n| project percent_of_messages , less_than_millisec_taken\\r\\n| order by percent_of_messages desc;\\r\\naggregated_publisher_data\",\"size\":1,\"aggregation\":1,\"showAnalytics\":true,\"title\":\"Time taken for publishing (percentile)\",\"color\":\"orange\",\"timeContextFromParameter\":\"TimeRange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights\\/workspaces\",\"visualization\":\"timechart\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Count\",\"formatter\":4,\"formatOptions\":{\"showIcon\":true},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}}],\"filter\":true},\"sortBy\":[],\"tileSettings\":{\"showBorder\":false},\"graphSettings\":{\"type\":0},\"chartSettings\":{\"xSettings\":{\"numberFormatSettings\":{\"unit\":1,\"options\":{\"style\":\"decimal\",\"useGrouping\":true}}},\"ySettings\":{\"numberFormatSettings\":{\"unit\":23,\"options\":{\"style\":\"decimal\",\"useGrouping\":true}}}},\"mapSettings\":{\"locInfo\":\"LatLong\",\"sizeSettings\":\"percent_of_messages\",\"sizeAggregation\":\"Sum\",\"legendMetric\":\"percent_of_messages\",\"legendAggregation\":\"Sum\",\"itemColorSettings\":{\"type\":\"heatmap\",\"colorAggregation\":\"Sum\",\"nodeColorField\":\"percent_of_messages\",\"heatmapPalette\":\"greenRed\"}}},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Edge\"},\"showPin\":true,\"name\":\"query - 3\"},{\"type\":3,\"content\":{\"version\":\"KqlItem\\/1.0\",\"query\":\"InsightsMetrics\\r\\n| where Name startswith \\\"iiot_edge\\\"\\r\\n    and Name endswith \\\"reconnected\\\"\\r\\n    and Name !contains \\\"device\\\" \\r\\n| extend module = tostring(parse_json(Tags).module) \\r\\n| extend device = tostring(parse_json(Tags).device) \\r\\n| summarize Count = max(Val)  by module, device , Name\\r\\n| project strcat(device, \\\"-\\\", module, \\\"-\\\", Name), Count\\r\\n\",\"size\":4,\"aggregation\":5,\"showAnalytics\":true,\"title\":\"Module Device Reconnection\",\"timeContextFromParameter\":\"TimeRange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights\\/workspaces\",\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"Column1\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}},\"showBorder\":false,\"size\":\"auto\"}},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Edge\"},\"showPin\":true,\"name\":\"query - 8\"},{\"type\":3,\"content\":{\"version\":\"KqlItem\\/1.0\",\"query\":\"\\r\\nInsightsMetrics\\r\\n| where Name startswith \\\"iiot_edge_publisher_monitored_items\\\"\\r\\n| extend subscription_id = tostring(parse_json(Tags).subscription) \\r\\n| project TimeGenerated ,  subscription_id , monitored_items = toint(Val)\\r\\n| render timechart \\r\\n\",\"size\":1,\"aggregation\":5,\"showAnalytics\":true,\"title\":\"Monitored nodes per subscription\",\"timeContextFromParameter\":\"TimeRange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights\\/workspaces\",\"visualization\":\"timechart\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Count\",\"formatter\":4,\"formatOptions\":{\"min\":0,\"palette\":\"blue\",\"showIcon\":true}}],\"filter\":true},\"sortBy\":[]},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Overview\"},\"showPin\":true,\"name\":\"query - 9\"},{\"type\":3,\"content\":{\"version\":\"KqlItem\\/1.0\",\"query\":\" InsightsMetrics\\r\\n| where Name startswith \\\"iiot_edge_twin_\\\" and Name !contains \\\"hist\\\" \\r\\n| summarize arg_max(TimeGenerated, *) by Name\\r\\n| summarize total_calls = sum(toint(Val))\",\"size\":4,\"showAnalytics\":true,\"title\":\"Total calls to twin module\",\"timeContextFromParameter\":\"TimeRange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights\\/workspaces\",\"visualization\":\"tiles\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Count\",\"formatter\":4,\"formatOptions\":{\"showIcon\":true},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\"}}}]},\"sortBy\":[],\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"total_calls\",\"formatter\":12,\"formatOptions\":{\"palette\":\"blue\"}},\"showBorder\":false,\"size\":\"auto\"}},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Edge\"},\"showPin\":true,\"name\":\"query - 3 - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem\\/1.0\",\"query\":\"InsightsMetrics\\r\\n| where Name startswith \\\"iiot_edge_twin_\\\" and Name !contains \\\"hist\\\" \\r\\n| summarize arg_max(TimeGenerated, *) by Name\\r\\n| project Method_name = substring(Name, 15), Total_calls = Val, Timestamp = TimeGenerated \\r\\n| where Total_calls != \\\"0\\\"\\r\\n| order by Total_calls desc\",\"size\":1,\"showAnalytics\":true,\"title\":\"Twin Module API calls\",\"timeContextFromParameter\":\"TimeRange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights\\/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"filter\":true}},\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Edge\"},\"showPin\":true,\"name\":\"query - 11\"},{\"type\":3,\"content\":{\"version\":\"KqlItem\\/1.0\",\"query\":\"\\r\\nInsightsMetrics\\r\\n| where Name == \\\"iiot_edge_publisher_exceptions\\\"\\r\\n| extend type_ = tostring(parse_json(Tags).type) \\r\\n| extend source_ = tostring(parse_json(Tags).source) \\r\\n| extend agent_ = tostring(parse_json(Tags).agent) \\r\\n| extend custom_message_ = tostring(parse_json(Tags).custom_message) \\r\\n| extend stacktrace_ = tostring(parse_json(Tags).stacktrace) \\r\\n| summarize arg_max(TimeGenerated, *) by Name , type_, source_, stacktrace_, agent_\\r\\n| project TimeGenerated, type_ , source_ , count_of_exceptions = tolong(Val), custom_message_, agent_, stacktrace_\\r\\n\",\"size\":1,\"showAnalytics\":true,\"title\":\"Exception Details\",\"timeContextFromParameter\":\"TimeRange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights\\/workspaces\",\"gridSettings\":{\"filter\":true}},\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Edge\"},\"showPin\":true,\"name\":\"query - 12\"},{\"type\":3,\"content\":{\"version\":\"KqlItem\\/1.0\",\"query\":\"let max_records_sent = InsightsMetrics\\r\\n| where Name == \\\"iiot_edge_twin_browse_hist_count\\\"\\r\\n| order by TimeGenerated desc\\r\\n| project message_count = Val\\r\\n| limit 1;\\r\\nlet aggregated_twin_browse_data = InsightsMetrics\\r\\n| where Name == \\\"iiot_edge_twin_browse_hist_bucket\\\"\\r\\n| extend time_taken_less_than = tostring(parse_json(Tags).le) \\r\\n| summarize arg_max(TimeGenerated, *) by Name , time_taken_less_than\\r\\n| extend total_messages = toscalar(max_records_sent)\\r\\n| where time_taken_less_than != \\\"\\\" and time_taken_less_than != \\\"+Inf\\\"\\r\\n| extend less_than_millisec_taken = todouble(time_taken_less_than) * 1000\\r\\n| extend percent_of_messages = todouble(Val) * 100 \\/ toint(total_messages)\\r\\n| where percent_of_messages < 99.99 and percent_of_messages > 50\\r\\n| project percent_of_messages , less_than_millisec_taken\\r\\n| order by percent_of_messages desc;\\r\\naggregated_twin_browse_data\",\"size\":0,\"aggregation\":1,\"title\":\"Time taken to browse nodes (percentile)\",\"color\":\"red\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights\\/workspaces\",\"visualization\":\"timechart\",\"chartSettings\":{\"xSettings\":{\"numberFormatSettings\":{\"unit\":1,\"options\":{\"style\":\"decimal\",\"useGrouping\":true}}},\"ySettings\":{\"numberFormatSettings\":{\"unit\":23,\"options\":{\"style\":\"decimal\",\"useGrouping\":true}}}}},\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Edge\"},\"name\":\"query - 10\"},{\"type\":3,\"content\":{\"version\":\"KqlItem\\/1.0\",\"query\":\"let count_per_controller = InsightsMetrics\\r\\n| where Name == \\\"http_request_duration_seconds_count\\\"\\r\\n| extend action_ = tostring(parse_json(Tags).action)\\r\\n| extend code_ = tostring(parse_json(Tags).code)\\r\\n| extend controller_ = tostring(parse_json(Tags).controller)\\r\\n| extend method_ = tostring(parse_json(Tags).method)\\r\\n| where controller_ <> \\\"Heartbeat\\\" \\r\\n| project TimeGenerated, Name, controller_, action_, code_, method_, Val\\r\\n| summarize arg_max(TimeGenerated, *) by controller_, action_, method_, code_\\r\\n| summarize RecordCount = sum(Val) by Controller = controller_;\\r\\ncount_per_controller\",\"size\":4,\"showAnalytics\":true,\"title\":\"Controller Hits\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights\\/workspaces\",\"visualization\":\"piechart\",\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"Applications\",\"color\":\"orange\"},{\"seriesName\":\"Publish\",\"color\":\"turquoise\"},{\"seriesName\":\"Other\",\"color\":\"gray\"},{\"seriesName\":\"Browse\",\"color\":\"green\"},{\"seriesName\":\"Discovery\",\"color\":\"redBright\"},{\"seriesName\":\"Publishers\",\"color\":\"magenta\"},{\"seriesName\":\"Workers\",\"color\":\"yellow\"}]}},\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Service\"},\"name\":\"query - 17\"},{\"type\":3,\"content\":{\"version\":\"KqlItem\\/1.0\",\"query\":\"InsightsMetrics\\r\\n| where Name == \\\"http_request_duration_seconds_count\\\"\\r\\n| extend action_ = tostring(parse_json(Tags).action)\\r\\n| extend code_ = tostring(parse_json(Tags).code)\\r\\n| extend controller_ = tostring(parse_json(Tags).controller)\\r\\n| extend method_ = tostring(parse_json(Tags).method)\\r\\n| where code_ <> \\\"0\\\" and controller_ <> \\\"Heartbeat\\\"\\r\\n| project TimeGenerated, Name, controller_, action_, code_, method_, Val\\r\\n| summarize arg_max(TimeGenerated, *) by controller_, action_, method_, code_\\r\\n| summarize RequestCount = sum(Val) by HttpCode = code_\\r\\n| render piechart ;\",\"size\":1,\"showAnalytics\":true,\"title\":\"Http Response Codes\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights\\/workspaces\",\"visualization\":\"piechart\",\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"200\",\"color\":\"green\"},{\"seriesName\":\"204\",\"color\":\"turquoise\"},{\"seriesName\":\"404\",\"color\":\"redBright\"},{\"seriesName\":\"500\",\"color\":\"blueDark\"}],\"ySettings\":{\"numberFormatSettings\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"useGrouping\":true}}}}},\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Service\"},\"name\":\"query - 18\"},{\"type\":3,\"content\":{\"version\":\"KqlItem\\/1.0\",\"query\":\"let max_count_per_method = InsightsMetrics \\r\\n| where Name == \\\"http_request_duration_seconds_count\\\"\\r\\n| extend action_ = tostring(parse_json(Tags).action)\\r\\n| extend code_ = tostring(parse_json(Tags).code)\\r\\n| extend controller_ = tostring(parse_json(Tags).controller)\\r\\n| extend method_ = tostring(parse_json(Tags).method)\\r\\n| where controller_ <> \\\"Heartbeat\\\"\\r\\n| project TimeGenerated, m = strcat(controller_,\\\":\\\" ,action_), Val\\r\\n| summarize arg_max(TimeGenerated, *) by m;\\r\\nlet max_duration_per_method =InsightsMetrics \\r\\n| where Name == \\\"http_request_duration_seconds\\\"\\r\\n| extend action_ = tostring(parse_json(Tags).action)\\r\\n| extend code_ = tostring(parse_json(Tags).code)\\r\\n| extend controller_ = tostring(parse_json(Tags).controller)\\r\\n| extend method_ = tostring(parse_json(Tags).method)\\r\\n| extend le_ = tostring(parse_json(Tags).le)\\r\\n| where controller_ <> \\\"Heartbeat\\\" and le_ != \\\"+Inf\\\"\\r\\n| summarize arg_max(TimeGenerated, *) by controller_, action_ , le_\\r\\n| project TimeGenerated, m = strcat(controller_,\\\":\\\" , action_), Val, le_;\\r\\nmax_duration_per_method\\r\\n| join kind=leftouter max_count_per_method on m\\r\\n| project TimeGenerated, m, Val, mVal = Val1, le_\\r\\n| extend percent_of_messages = todouble(Val) * 100 \\/ toint(mVal)\\r\\n| where percent_of_messages < 100 and percent_of_messages > 30\\r\\n| project percent_of_messages, rt_ms = todouble(le_) * 1000, API = m , a = strcat(percent_of_messages, m) \\r\\n| partition by a ( top 1 by rt_ms asc) \\r\\n| project API, rt_ms, percent_of_messages\\r\\n| sort by API, percent_of_messages desc;\\r\\n\",\"size\":0,\"aggregation\":2,\"showAnalytics\":true,\"title\":\"Response Time for API calls\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights\\/workspaces\",\"visualization\":\"linechart\",\"graphSettings\":{\"type\":0,\"topContent\":{\"columnMatch\":\"API\",\"formatter\":1},\"centerContent\":{\"columnMatch\":\"rt_ms\",\"formatter\":1,\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"chartSettings\":{\"xAxis\":\"percent_of_messages\",\"yAxis\":[\"rt_ms\"],\"seriesLabelSettings\":[{\"seriesName\":\"Browse:Browse\",\"color\":\"redBright\"},{\"seriesName\":\"Applications:GetApplicationRegistration\",\"color\":\"yellow\"},{\"seriesName\":\"Applications:QueryApplications\",\"color\":\"pink\"},{\"seriesName\":\"Endpoints:QueryEndpoints\",\"color\":\"green\"},{\"seriesName\":\"Endpoints:ActivateEndpoint\",\"color\":\"turquoise\"},{\"seriesName\":\"Endpoints:GetEndpoint\",\"color\":\"grayBlue\"},{\"seriesName\":\"Publish:GetFirstListOfPublishedNodes\",\"color\":\"orange\"}],\"xSettings\":{\"numberFormatSettings\":{\"unit\":1,\"options\":{\"style\":\"decimal\",\"useGrouping\":true}}},\"ySettings\":{\"numberFormatSettings\":{\"unit\":23,\"options\":{\"style\":\"decimal\",\"useGrouping\":true}}}}},\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Service\"},\"name\":\"query - 16\"},{\"type\":3,\"content\":{\"version\":\"KqlItem\\/1.0\",\"query\":\"exceptions \\r\\n| extend MessageTemplate_ = tostring(customDimensions.MessageTemplate)\\r\\n| summarize count() by MessageTemplate_\\r\\n| order by MessageTemplate_ desc   \",\"size\":0,\"showAnalytics\":true,\"title\":\"Exception Count by Message Type\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.insights\\/components\",\"crossComponentResources\":[\"<appinsights_resource_id>\"],\"visualization\":\"piechart\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"MessageTemplate_\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"count_\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"AppInsights\"},\"name\":\"query - 16\"},{\"type\":3,\"content\":{\"version\":\"KqlItem\\/1.0\",\"query\":\"traces\\r\\n|where severityLevel > 2\\r\\n|project timestamp, message\",\"size\":1,\"showAnalytics\":true,\"title\":\"Error logs - Severity 3\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.insights\\/components\",\"crossComponentResources\":[\"<appinsights_resource_id>\"],\"gridSettings\":{\"rowLimit\":100,\"filter\":true}},\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"AppInsights\"},\"name\":\"query - 20\"},{\"type\":3,\"content\":{\"version\":\"KqlItem\\/1.0\",\"query\":\"requests \\r\\n| summarize count() by performanceBucket\\r\\n\",\"size\":4,\"showAnalytics\":true,\"title\":\"Request Duration (Percentiles)\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.insights\\/components\",\"crossComponentResources\":[\"<appinsights_resource_id>\"],\"visualization\":\"tiles\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"performanceBucket\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"count_\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"AppInsights\"},\"name\":\"query - 17\"},{\"type\":3,\"content\":{\"version\":\"KqlItem\\/1.0\",\"query\":\"traces\\r\\n| where customDimensions.MessageTemplate startswith \\\"successfully processed\\\"\\r\\n| parse message with * \\\"processed \\\" record_count \\\" records\\\" *\\r\\n| project timestamp, records = toint(record_count)\\r\\n| summarize [\\\"total records\\\"] = sum(records) by bin(timestamp, 1m)\\r\\n| render timechart \",\"size\":0,\"showAnalytics\":true,\"title\":\"CDM : Number of records processed and written as CDM\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.insights\\/components\",\"crossComponentResources\":[\"<appinsights_resource_id>\"]},\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"AppInsights\"},\"name\":\"query - 18\"},{\"type\":3,\"content\":{\"version\":\"KqlItem\\/1.0\",\"query\":\"traces\\r\\n| where customDimensions.MessageTemplate startswith \\\"Finished writing CDM data records\\\"\\r\\n| parse message with * \\\"took \\\" time_taken \\\")\\\" *\\r\\n| project timestamp, t = totimespan(time_taken)\\/ time(1s)\\r\\n| summarize [\\\"time(sec)\\\"] = avg(t) by bin(timestamp, 5m)\\r\\n| render timechart \",\"size\":0,\"showAnalytics\":true,\"title\":\"CDM: Time taken to write CDM data records\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.insights\\/components\",\"crossComponentResources\":[\"<appinsights_resource_id>\"]},\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"AppInsights\"},\"name\":\"query - 19\"}],\"isLocked\":false,\"fallbackResourceIds\":[],\"fromTemplateId\":\"community-Workbooks\\/View Designer\\/Tabbed\"}",
    "workbookData":"[replace(variables('workbookDataTemplate'),'<appinsights_resource_id>', parameters('appInsightsId'))]"
  },
  "resources": [
    {
      "name": "[parameters('workbookId')]",
      "type": "microsoft.insights/workbooks",
      "location": "[resourceGroup().location]",
      "apiVersion": "2018-06-17-preview",
      "tags": "[parameters('tags')]",
      "dependsOn": [],
      "kind": "shared",
      "properties": {
        "displayName": "[parameters('workbookDisplayName')]",
        "serializedData": "[variables('workbookData')]",
        "version": "1.0",
        "sourceId": "[parameters('workbookSourceId')]",
        "category": "[parameters('workbookType')]"
      }
    }
  ],
  "outputs": {
    "workbookId": {
      "type": "string",
      "value": "[resourceId( 'microsoft.insights/workbooks', parameters('workbookId'))]"
    }
  }
}
