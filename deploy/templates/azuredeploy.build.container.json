{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "containerRegistryName": {
            "type": "string",
            "metadata": {
                "description": "Specifies the name of Azure Container Registry."
            }
        },
        "imageName": {
            "type": "string",
            "metadata": {
                "description": "The name of the image"
            }
        },
        "imageTags": {
            "type": "array",
            "defaultValue": [
                "latest"
            ],
            "metadata": {
                "description": "Image tag."
            }
        },
        "os": {
            "type": "string",
            "defaultValue": "linux",
            "allowedValues": [
                "linux",
                "windows"
            ],
            "metadata": {
                "description": "Image os."
            }
        },
        "architecture": {
            "type": "string",
            "defaultValue": "amd64",
            "allowedValues": [
                "amd64"
            ],
            "metadata": {
                "description": "Platform."
            }
        },
        "repoUrl": {
            "type": "string",
            "defaultValue": "https://github.com/Azure/Industrial-IoT",
            "metadata": {
                "description": "The repository url from which to deploy services and application.  Default is official repository."
            }
        },
        "branchName": {
            "type": "string",
            "defaultValue": "master",
            "metadata": {
                "description": "The branch from which to deploy deploy services and application.  Default to master."
            }
        },
        "dockerFilePath": {
            "type": "string",
            "metadata": {
                "description": "Path to the docker file in the repo."
            }
        },
        "gitHubPat": {
            "type": "securestring",
            "defaultValue": "",
            "metadata": {
                "description": "The github personal access token to setup continouus integration."
            }
        },
        "managedIdentityResourceId": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "A user created managed identity to use for service to service access. "
            }
        },
        "location": {
            "type": "string",
            "defaultValue": "westus",
            "metadata": {
                "description": "Specifies the name of Azure Container Registry."
            }
        }
    },
    "variables": {
        "copy": [
            {
                "name": "imageNames",
                "count": "[length(parameters('imageTags'))]",
                "input": "[concat(parameters('imageName'), ':', parameters('imageTags')[copyIndex('imageNames')])]"
            }
        ],
        "osShort": "[if (equals(parameters('os'), 'windows'), 'win', parameters('os'))]",
        "containerResourceName": "[concat(replace(replace(parameters('imageName'), '-', ''), '/', ''), variables('osShort'), parameters('architecture'))]",
        "gitHubCiTrigger": [
            {
                "name": "defaultSourceTriggerName",
                "sourceRepository": {
                    "branch": "[parameters('branchName')]",
                    "repositoryUrl": "[parameters('repoUrl')]",
                    "sourceControlAuthProperties": {
                        "tokenType": "PAT",
                        "token": "[parameters('gitHubPat')]"
                    },
                    "sourceControlType": "GitHub"
                },
                "status": "Enabled",
                "sourceTriggerEvents": [
                    "commit"
                ]
            }
        ],
        "taskName": "[toLower(concat(variables('containerResourceName'), 'BuildTask'))]",
        "taskId": "[resourceId('Microsoft.ContainerRegistry/registries/tasks', parameters('containerRegistryName'), variables('taskName'))]",
        "identity": {
            "type": "UserAssigned",
            "userAssignedIdentities": {
                "[parameters('managedIdentityResourceId')]": {
                }
            }
        }
    },
    "resources": [
        {
            "comments": "Container build.",
            "name": "[concat(parameters('containerRegistryName'), '/', variables('taskName'))]",
            "type": "Microsoft.ContainerRegistry/registries/tasks",
            "location": "[parameters('location')]",
            "apiVersion": "2019-04-01",
            "identity": "[if(not(empty(parameters('managedIdentityResourceId'))), variables('identity'), '')]",
            "properties": {
                "agentConfiguration": {
                    "cpu": 2
                },
                "platform": {
                    "os": "[parameters('os')]",
                    "architecture": "[parameters('architecture')]"
                },
                "timeout": 3600,
                "step": {
                    "type": "Docker",
                    "arguments": [
                    ],
                    "imageNames": "[variables('imageNames')]",
                    "dockerFilePath": "[parameters('dockerFilePath')]",
                    "contextPath": "[concat(parameters('repoUrl'), '#', parameters('branchName'))]",
                    "isPushEnabled": true,
                    "noCache": false
                },
                "trigger": {
                    "baseImageTrigger": {
                        "baseImageTriggerType": "Runtime",
                        "name": "defaultBaseimageTriggerName",
                        "status": "Enabled"
                    },
                    "sourceTriggers": "[if(empty(parameters('gitHubPat')), json('null'), variables('gitHubCiTrigger'))]"
                },
                "status": "Enabled"
            },
            "dependsOn": [
            ]
        },
        {
            "comments": "Kick off task.",
            "name": "[concat(parameters('containerRegistryName'), '/', variables('taskName'))]",
            "type": "Microsoft.ContainerRegistry/registries/taskruns",
            "location": "[parameters('location')]",
            "apiVersion": "2019-06-01-preview",
            "identity": "[if(not(empty(parameters('managedIdentityResourceId'))), variables('identity'), '')]",
            "properties": {
                "runRequest": {
                    "type": "TaskRunRequest",
                    "taskId": "[variables('taskId')]"
                }
            },
            "dependsOn": [
                "[variables('taskId')]"
            ]
        }
    ]
}