# Adding an AKS cluster with Azure IIoT components on top of PS1 deployment

This article explains how to add an AKS cluster and deploy components of Azure Industrial IoT platform using
a Helm chart on top of a platform deployed through either `deploy.cmd` or `deploy.sh` scripts. Those scripts
are deploying components of Azure Industrial IoT platform into two instances of Azure App Services, and as
such they do not provide high degree of scalability and high-availability. We recommend using those scripts
for PoC and demo purposes. For production scenarios, we recommend running component of Azure Industrial IoT
platform in Kubernetes cluster. This article will guide you through the steps of making your existing
deployment into a more production-ready one.

Please note that we also provide `Microsoft.Azure.IIoT.Deployment (Preview)` command-line application, which
similar to deployment scripts creates an instance of Azure Industrial IoT platform. In contrast to
`deploy.cmd` or `deploy.sh` scripts, it deploys components of Azure Industrial IoT platform into an AKS
cluster. Please use that application if you are starting from scratch:

* Deploying Azure Industrial IoT Platform to [Azure Kubernetes Service (AKS)](howto-deploy-aks.md) as production solution.

Here we are going to assume that you have already successfully run `deploy.cmd` or `deploy.sh` scripts and
have the `.env` file that has been generated by them:

* [Azure Industrial IoT Platform and Simulation demonstrator using the deployment script](howto-deploy-all-in-one.md)

## Prerequisites

* Azure CLI: [Install the Azure CLI](https://docs.microsoft.com/cli/azure/install-azure-cli)
* `kubectl`: You can run the following command to install `kubectl` using Azure CLI:

  ```bash
  az aks install-cli
  ```

* Helm 3: You can run the following command to install `helm` using Azure CLI:

  ```bash
  az acr helm install-cli
  ```

## Steps

The steps to create AKS cluster with static public IP address bellow are based on the following tutorial:

* [Create an ingress controller with a static public IP address in Azure Kubernetes Service (AKS)](https://docs.microsoft.com/azure/aks/ingress-static-ip)

### Create an AKS cluster

Go to the resource group that houses your deployment of Azure Industrial IoT platform and create and AKS
cluster in it. Please follow the steps in this tutorial and note the steps below it:

* [Create an AKS cluster using Azure portal](https://docs.microsoft.com/azure/aks/kubernetes-walkthrough-portal#create-an-aks-cluster)

1. On the **Basics** page, give a name to your cluster, let's say `aks-cluster`.
2. On the **Node pools** page, keep the default to go further.
3. on the **Authentication** page, select `System-assigned managed identity` as `Authentication method`.
4. On the **Networking** page, you can either use the default or set `Network configuration` to `Advanced`
  and add the cluster to and existing VNet.
5. On the **Integrations** page, make sure that `Container monitoring` is set to `Enabled` and set
  `Log Analytics workspace` to an instance in your resource group.
6. On the **Tags** page, you can add custom tags.
7. On the **Review + create** page, review cluster details and create it.

Now please wait for the AKS cluster to be created. That might take up to 15 minutes.

### Create a Public IP address

After AKS cluster has been created, we will create a Public IP address resource in the resource group managed
by the AKS cluster. Please check for it the list of your resource groups, it will have the following naming
format:

`MC_<myResouceGroup>_<aksClusterName>_<regionName>`

Go to it and create a Public IP address resource using Azure Portal and apply the following changes:

On the **Create public IP address** page:

1. Set `SKU` to `Standard`.
2. Set a `Name` for the resource, let's say `aks-cluster-ip`.
3. Set a `DNS name label`, let's say `aks-cluster-ip`. This will determine URL of our services.
4. Make sure it uses the same `Location` as your AKS cluster and the rest of your resources.

Now please wait for the Public IP address to be created.

Once it is created, go to the **Overview** page of the Public IP address and copy the following details,
we will need them when deploying NGINX Ingress Controller and Azure Industrial IoT Helm charts:

* `IP address`
* `DNS name`

### Get credentials for kubectl

Provide your resource group and AKS cluster names:

```bash
az aks get-credentials --resource-group myResourceGroup --name myAksCluster
```

### Create ClusterRoleBinding for Kubernetes Dashboard

```bash
kubectl create clusterrolebinding kubernetes-dashboard --clusterrole=cluster-admin --serviceaccount=kube-system:kubernetes-dashboard
```

### Deploy NGINX Ingress Controller

Create `nginx-ingress` namespace:

```bash
kubectl create namespace nginx-ingress
```

Add `stable` Helm chart repository:

```bash
helm repo add stable https://kubernetes-charts.storage.googleapis.com/
helm repo update
```

Create `nginx-ingress.yaml` file that we will use for deploying the Helm chart based on the template below.

Apply the following changes:

1. Use IP address of the Public IP address resource that we created earlier instead of `<Public IP address>`
2. Use DNS name label that you set when creating the Public IP address resource instead of
  `<Public IP DNS name label>`. Use the value that you set when creating the resource, which is only the
  **first part** of the hostname and **not** the whole hostname.

```yaml
controller:
  replicaCount: 2
  nodeSelector:
    beta.kubernetes.io/os: linux
  service:
    loadBalancerIP: <Public IP address>
    annotations:
      service.beta.kubernetes.io/azure-dns-label-name: <Public IP DNS name label>
  config:
    compute-full-forward-for: "true"
    use-forward-headers: "true"
    proxy-buffer-size: "32k"
    client-header-buffer-size: "32k"
  metrics:
    enabled: true
defaultBackend:
  nodeSelector:
    beta.kubernetes.io/os: linux
```

Install `stable/nginx-ingress` Helm chart using `nginx-ingress.yaml` file created above.

```bash
helm install nginx-ingress stable/nginx-ingress --namespace nginx-ingress --version 1.36.0 -f nginx-ingress.yaml
```

### Deploy cert-manager Helm chart

Install the `CustomResourceDefinition` resources:

```bash
kubectl apply --validate=false -f https://raw.githubusercontent.com/jetstack/cert-manager/release-0.13/deploy/manifests/00-crds.yaml
```

Create `cert-manager` namespace and label it to disable resource validation:

```bash
kubectl create namespace cert-manager
kubectl label namespace cert-manager cert-manager.io/disable-validation=true
```

Add `jetstack` Helm chart repository:

```bash
helm repo add jetstack https://charts.jetstack.io
helm repo update
```

Install `jetstack/cert-manager` Helm chart:

```bash
helm install cert-manager jetstack/cert-manager --namespace cert-manager --version v0.13.0
```

### Create ClusterIssuer resource

Create a `ClusterIssuer` resource using the following `cluster-issuer.prod.yaml` file.
You can set your email address in `ClusterIssuer` so that letsencrypt informs you if they find issues with
the certificate that was issued to you. To do that uncomment `email:` line and set the value.

```yaml
apiVersion: cert-manager.io/v1alpha2
kind: ClusterIssuer
metadata:
  name: letsencrypt-prod
spec:
  acme:
    # The ACME server URL
    server: https://acme-v02.api.letsencrypt.org/directory
    # Email address used for ACME registration
    # email: <your-email-address@something.com>
    # Name of a secret used to store the ACME account private key
    privateKeySecretRef:
      name: letsencrypt-prod
    # Enable the HTTP-01 challenge provider
    solvers:
    - http01:
        ingress:
          class: nginx
```

Run the command:

```bash
kubectl apply -f cluster-issuer.prod.yaml
```

### Stop App Services

Before deploying `azure-industrial-iot` Helm chart, please go to your resource group, find App Service
resources and stop them. This will ensure that there are no two versions of the platform running at the
same time as that may cause some issues with module deployments in IoT Hub.

### Deploy azure-industrial-iot Helm chart

Create `aiiot` namespace:

```bash
kubectl create namespace aiiot
```

Now you will need to decide whether you want to use configuration that has been pushed to Azure Key Vault
as secrets by deploy scripts or pass details of all required Azure resources through YAML file. Based on
that the YAML files for `azure-industrial-iot` Helm chart will look a bit differently.

#### Using configuration in Azure Key Vault

To use the configuration in Azure Key Vault we need to set up Access Policies for service principal of
`servicesApp` app so that microservice have permission to read secrets from Azure Keyvault.

We would also need to enable configuration loading from Azure Key Vault by setting `loadConfFromKeyVault` to `true` for the chart.

In Azure portal, go the the Key Vault resource that has been

When `loadConfFromKeyVault` is set to `true`, our microservices will try to read configuration secrets from
your Azure Key Vault instance. So you would have to make sure that `servicesApp` has enough permissions to
access the Azure Key Vault. We require the following Access Policies to be set for service principal of
`servicesApp` so that microservices can function properly:

* Key Permissions: `get`, `list`, `sign`, `unwrapKey`, `wrapKey`, `create`
* Secret Permissions: `get`, `list`, `set`, `delete`
* Certificate Permissions: `get`, `list`, `update`, `create`, `import`


ToDo: Finish this section.

#### Passing Azure resource details through YAML file

If you decide to pass Azure resource details through YAML file, please follow
[documentation of `azure-industrial-iot` Helm chart](../../deploy/helm/azure-industrial-iot/README.md)
to get the parameters. In the end `aiiot.yaml` file will look something like this:

```yaml
```

#### Installing the chart

Install Azure Industrial IoT Helm chart from root of the repo and use `aiiot.yaml` that you generated above:

```bash
helm install aiiot -n aiiot .\deploy\helm\azure-industrial-iot\ -f aiiot.yaml
```

### Check status of deployed resources

To check status of deployed resources let's open Kubernetes Dashboard. Please provide your resource group
and AKS cluster names:

```bash
az aks browse --resource-group myResourceGroup --name myAksCluster
```

### Enable Prometheus metrics scraping

To enable prometheus metrics scraping let's use `04_oms_agent_configmap.yaml` file that we have in the repo:

```bash
kubectl apply -f .\deploy\src\Microsoft.Azure.IIoT.Deployment\Resources\aks\04_oms_agent_configmap.yaml
```

### Update RedirectURLs of web App Registration

ToDo:

### Remove App Service and App Service Plan

ToDo:
