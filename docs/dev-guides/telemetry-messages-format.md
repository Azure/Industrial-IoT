# Telemetry Messages Processing

[Home](readme.md)

Work in progress!!

Telemetry messagees used by the IIoT Platform


## From IoT Hub - Generated by Edge Publisher

### Samples Mode

Json Encoding

```json
{
  "body": {
    "NodeId": "http://test.org/UA/Data/#i=10845",
    "EndpointUrl": "opc.tcp://172.17.126.1:51210/UA/Server",
    "ApplicationUri": "urn:IndustrialHost01:OpcUaServer",
    "DisplayName": "SByteValue",
    "Timestamp": "2020-03-25T00:30:59.8229777Z",
    "Status": "Good",
    "Value": {
      "Value": -30,
      "SourceTimestamp": "2020-03-25T00:30:59.0134194Z",
      "ServerTimestamp": "2020-03-25T00:30:59.0134194Z"
    },
    "ExtensionFields": {
      "EndpointId": "uat46f9f8f82fd5c1b42a7de31b5dc2c11ef418a62f",
      "PublisherId": "uat46f9f8f82fd5c1b42a7de31b5dc2c11ef418a62f",
      "DataSetWriterId": "uat46f9f8f82fd5c1b42a7de31b5dc2c11ef418a62f"
    }
  },
  "enqueuedTime": "2020-03-25T00:31:00.078Z",
  "properties": {
    "iothub-creation-time-utc": "2020-03-25T00:30:59.8797427Z",
    "$$ContentType": "application/x-monitored-item-json-v1",
    "$$ContentEncoding": "utf-8",
    "$$CreationTimeUtc": "03/25/20 12:30:59 AM"
  }
}
```

Binary Encoding

```json
{
  "body": "U\u001f\u0000\u0000\u0001\u0003^*\u0018\u0000\u0000\u0000http://test.org/UA/Data/*\u0000\u0000\u0000opc.tcp://172.17.126.1:51210/UA/Server%\u0000\u0000\u0000urn:IndustrialHost01:OpcUaServer\t\u0000\u0000\u0000ByteValue\u0003\u000fy\u001f4\u0002V\u0001\r\u0003iV\u0013]\u001f4\u0002V\u0001V\u0013]\u001f4\u0002V\u0001\u0003\u0000\u0000\u0000\u0000\u0000\n\u0000\u0000\u0000EndpointId\f+\u0000\u0000\u0000uat46f9f8f82fd5c1b42a7de31b5dc2c11ef418a62f\u0000\u0000\u000b\u0000\u0000\u0000PublisherId\f+\u0000\u0000\u0000uat46f9f8f82fd5c1b42a7de31b5dc2c11ef418a62f\u0000\u0000\u000f\u0000\u0000\u0000DataSetWriterId\f+\u0000\u0000\u0000uat46f9f8f82fd5c1b42a7de31b5dc2c11ef418a62f",
  "enqueuedTime": "2020-03-24T23:33:30.978Z",
  "properties": {
    "iothub-creation-time-utc": "2020-03-24T23:33:30.7710485Z",
    "$$ContentType": "application/x-monitored-item-uabinary-v1",
    "$$ContentEncoding": "utf-8",
    "$$CreationTimeUtc": "03/24/20 11:33:30 PM"
  },
  "systemProperties": {
    "iothub-connection-device-id": "DataSetWriterV2_uat46f9f8f82fd5c1b42a7de31b5dc2c11ef418a62f",
    "iothub-connection-auth-method": "{\"scope\":\"device\",\"type\":\"sas\",\"issuer\":\"iothub\",\"acceptingIpFilterRule\":null}",
    "iothub-connection-auth-generation-id": "637204283934176220",
    "iothub-enqueuedtime": 1585092810743,
    "iothub-message-source": "Telemetry",
    "x-opt-sequence-number": 502705,
    "x-opt-offset": "94502792056",
    "x-opt-enqueued-time": 1585092810978
  }
}
```

### OPC UA Pub/Sub Mode

Json Encoding

```json
{
  "body": {
    "MessageId": "18",
    "MessageType": "ua-data",
    "PublisherId": "uat46f9f8f82fd5c1b42a7de31b5dc2c11ef418a62f",
    "DataSetClassId": "78c4e91c-82cb-444e-a8e0-6bbacc9a946d",
    "Messages": [
      {
        "DataSetWriterId": "uat46f9f8f82fd5c1b42a7de31b5dc2c11ef418a62f",
        "SequenceNumber": 18,
        "MetaDataVersion": {
          "MajorVersion": 1,
          "MinorVersion": 1
        },
        "Timestamp": "2020-03-24T23:30:56.9597112Z",
        "Status": null,
        "Payload": {
          "http://test.org/UA/Data/#i=10845": {
            "Value": 99,
            "SourceTimestamp": "2020-03-24T23:30:55.9891469Z",
            "ServerTimestamp": "2020-03-24T23:30:55.9891469Z"
          },
          "http://test.org/UA/Data/#i=10846": {
            "Value": 251,
            "SourceTimestamp": "2020-03-24T23:30:55.9891469Z",
            "ServerTimestamp": "2020-03-24T23:30:55.9891469Z"
          }
        }
      }
    ]
  },
  "enqueuedTime": "2020-03-24T23:30:57.130Z",
  "properties": {
    "iothub-creation-time-utc": "2020-03-24T23:30:56.9612338Z",
    "$$ContentType": "application/x-network-message-json-v1",
    "$$ContentEncoding": "utf-8",
    "$$CreationTimeUtc": "03/24/20 11:30:56 PM"
  },
  "systemProperties": {
    "iothub-connection-device-id": "DataSetWriterV2_uat46f9f8f82fd5c1b42a7de31b5dc2c11ef418a62f",
    "iothub-connection-auth-method": "{\"scope\":\"device\",\"type\":\"sas\",\"issuer\":\"iothub\",\"acceptingIpFilterRule\":null}",
    "iothub-connection-auth-generation-id": "637204283934176220",
    "iothub-enqueuedtime": 1585092656941,
    "iothub-message-source": "Telemetry",
    "x-opt-sequence-number": 502469,
    "x-opt-offset": "94502523208",
    "x-opt-enqueued-time": 1585092657130
  }
}
```

Binary Encoding:

``` Json
{
  "body": "u\u0002\u0000\u0000\u0002\u0000\u0000\u000029\u0007\u0000\u0000\u0000ua-data+\u0000\u0000\u0000uat46f9f8f82fd5c1b42a7de31b5dc2c11ef418a62f$\u0000\u0000\u000078c4e91c-82cb-444e-a8e0-6bbacc9a946d\u0001\u0000\u0000\u0000=\u0000\u0000\u0000+\u0000\u0000\u0000uat46f9f8f82fd5c1b42a7de31b5dc2c11ef418a62f\u001d\u0000\u0000\u0000\u0001\u0000\u0000\u0000\u0001\u0000\u0000\u0000[}\u001055\u0002V\u0001\u0000\u0000\u0000\u0000\u0002\u0000\u0000\u0000 \u0000\u0000\u0000http://test.org/UA/Data/#i=10846\r\u0003\n|\u000f\u001755\u0002V\u0001|\u000f\u001755\u0002V\u0001 \u0000\u0000\u0000http://test.org/UA/Data/#i=10845\r\u0002*|\u000f\u001755\u0002V\u0001|\u000f\u001755\u0002V\u0001",
  "enqueuedTime": "2020-03-24T23:37:41.298Z",
  "properties": {
    "iothub-creation-time-utc": "2020-03-24T23:37:40.9194946Z",
    "$$ContentType": "application/x-network-message-uadp-v1",
    "$$CreationTimeUtc": "03/24/20 11:37:40 PM"
  },
  "systemProperties": {
    "iothub-connection-device-id": "DataSetWriterV2_uat46f9f8f82fd5c1b42a7de31b5dc2c11ef418a62f",
    "iothub-connection-auth-method": "{\"scope\":\"device\",\"type\":\"sas\",\"issuer\":\"iothub\",\"acceptingIpFilterRule\":null}",
    "iothub-connection-auth-generation-id": "637204283934176220",
    "iothub-enqueuedtime": 1585093061235,
    "iothub-message-source": "Telemetry",
    "x-opt-sequence-number": 503200,
    "x-opt-offset": "94503278664",
    "x-opt-enqueued-time": 1585093061298
  }
}
```

### Standalone Publisher mode - Legacy

Full featured message sample

Enhanced compatibility with new version of the IIoT Platform's telemetry processors. Publisher to be started in standalone mode with *--fm=true* argument

```json
{
  "body": {
    "NodeId": "http://test.org/UA/Data/#i=10845",
    "EndpointUrl": "opc.tcp://172.17.126.1:51210/UA/Server",
    "ApplicationUri": "urn:IndustrialHost01:OpcUaServer",
    "DisplayName": "SByteValue",
    "Timestamp": "2020-03-25T00:33:19.8346363Z",
    "Status": "Good",
    "Value": {
      "Value": 8,
      "SourceTimestamp": "2020-03-25T00:33:19.6377132Z",
      "ServerTimestamp": "2020-03-25T00:33:19.6377132Z"
    },
    "ExtensionFields": {
      "EndpointId": "uat46f9f8f82fd5c1b42a7de31b5dc2c11ef418a62f",
      "PublisherId": "uat46f9f8f82fd5c1b42a7de31b5dc2c11ef418a62f",
      "DataSetWriterId": "uat46f9f8f82fd5c1b42a7de31b5dc2c11ef418a62f"
    }
  },
  "enqueuedTime": "2020-03-25T00:33:19.878Z",
  "properties": {
    "iothub-creation-time-utc": "2020-03-25T00:33:19.8817621Z",
    "$$ContentType": "application/x-monitored-item-json-v1",
    "$$ContentEncoding": "utf-8",
    "$$CreationTimeUtc": "03/25/20 12:33:19 AM"
  }
}
```

Legacy compatibibility mode (reduced) message sample

Compatible with the Legacy IIoT Platform respective Connected Factory 1.0.Publisher to be started in standalone mode with *--fm=false* argument

```json
{
  "body": {
    "NodeId": "http://test.org/UA/Data/#i=10846",
    "ApplicationUri": "urn:IndustrialHost01:OpcUaServer",
    "DisplayName": "ByteValue",
    "Status": "Good",
    "Value": {
      "Value": 116,
      "SourceTimestamp": "2020-03-25T00:48:31.3113861Z"
    }
  },
  "enqueuedTime": "2020-03-25T00:48:31.589Z",
  "properties": {
    "iothub-creation-time-utc": "2020-03-25T00:48:31.5485509Z",
    "$$ContentType": "application/x-monitored-item-json-v1",
    "$$ContentEncoding": "utf-8",
    "$$CreationTimeUtc": "03/25/20 12:48:31 AM"
  }
}
```

## From Event Hub - Generated by the Telemetry Processor

### Samples Mode

Message body is
```json
{
  "publisherId": "uat46f9f8f82fd5c1b42a7de31b5dc2c11ef418a62f",
  "dataSetClassId": "http://test.org/UA/Data/#i=10845",
  "dataSetWriterId": "uat46f9f8f82fd5c1b42a7de31b5dc2c11ef418a62f",
  "sequenceNumber": 0,
  "metaDataVersion": "1.0",
  "status": "Good",
  "timestamp": "2020-03-24T23:54:23.4955724Z",
  "payload": {
    "http://test.org/UA/Data/#i=10845": {
      "value": 27,
      "sourceTimestamp": "2020-03-24T23:54:23.1307846Z",
      "serverTimestamp": "2020-03-24T23:54:23.1307846Z"
    }
  }
}
```

### OPC UA Pub/Sub Mode

Message body is
```json
{
  "messageId": "21",
  "publisherId": "uat46f9f8f82fd5c1b42a7de31b5dc2c11ef418a62f",
  "dataSetClassId": "78c4e91c-82cb-444e-a8e0-6bbacc9a946d",
  "dataSetWriterId": "uat46f9f8f82fd5c1b42a7de31b5dc2c11ef418a62f",
  "sequenceNumber": 21,
  "metaDataVersion": "1.1",
  "status": "Good",
  "timestamp": "2020-03-25T00:00:28.5713393Z",
  "payload": {
    "http://test.org/UA/Data/#i=10845": {
      "value": -91,
      "sourceTimestamp": "2020-03-25T00:00:28.0498921Z",
      "serverTimestamp": "2020-03-25T00:00:28.0498921Z"
    },
    "http://test.org/UA/Data/#i=10846": {
      "value": 89,
      "sourceTimestamp": "2020-03-25T00:00:28.0498921Z",
      "serverTimestamp": "2020-03-25T00:00:28.0498921Z"
    }
  }
}
```