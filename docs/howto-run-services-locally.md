# Run the Azure Industrial IoT Services locally

The micro services contained in this repository provide a REST like API on top of our Azure Industrial IoT components, for example our [OPC UA components](https://github.com/Azure/azure-iiot-opc-ua).  

## Prerequisites

Ensure you have deployed the Azure Platform dependencies for all services in this repository and retrieved the resulting `.env` file.  If you have not, please follow the instructions at

- [How to deploy Azure dependencies](howto-deploy-dependencies.md)

If you have not done so yet, clone this GitHub repository.  To clone the repository you need git.  If you do not have git installed on your system, follow the instructions for [Linux or Mac](https://git-scm.com/book/en/v2/Getting-Started-Installing-Git), or [Windows](https://gitforwindows.org/) to install it.  To clone the repository, open a command prompt or terminal and run:

```bash
git clone --recursive https://github.com/Azure/azure-iiot-components 
cd azure-iiot-components
```

## Start all Industrial IoT micro services locally using Docker

The easiest way to start all services is to use the `docker-compose.yml` file located in this repository's root folder.

1. Please make sure you have Docker and docker-compose installed on your development PC.  If you have not, please follow the instructions for [Linux](https://docs.docker.com/install/linux/docker-ce/ubuntu/), [Mac](https://docs.docker.com/docker-for-mac/install/), or on [Windows](https://docs.docker.com/docker-for-windows/install/).

2. Change into the root of the repository and ensure the `.env` file generated during deployment is located there.  If it is not, copy it here (see [Prerequisites](#Prerequisites)).  

3. Run

   ```bash
   docker-compose up
   ```

   And follow the instructions below to [ensure the services are running](#Ensure-the-services-are-running).

## Build and run the services with Visual Studio or VS Code

1. First, make sure your development tool chain is setup to build the services.  If you have not, [install .NET Core 2.1+][dotnet-install] and any recent edition of Visual Studio (Windows/MacOS) or Visual Studio Code (Windows/MacOS/Linux).
   - If you already have Visual Studio installed, then ensure you have [.NET Core Tools for Visual Studio 2017][dotnetcore-tools-url] installed (Windows only).
   - If you already have VS Code installed, then ensure you have the [C# for Visual Studio Code (powered by OmniSharp)][omnisharp-url] extension installed. 
2. Ensure that the `.env` file previously generated by the deployment script is located in the repository root. 
3. Open the `azure-iiot-components.sln` solution file in Visual Studio or VS Code
4. Right click on the solution in the solution viewer and select `Properties`. Set the start up projects to be all projects matching `Microsoft.Azure.IIoT.Services.OpcUa.*`.  Set them to "Start".
5. Start debugging by pressing the "Start" button or hitting F5.
6. [Ensure the services are running](#Ensure-the-services-are-running)

## Ensure the services are running

After starting open a browser window to

- http://localhost:9042 for OPC Registry Service
- http://localhost:9041 for OPC Twin Service
- http://localhost:9043 for OPC Historic Access Service

which will show you the each Service's swagger UI.  If the services exit immediately after start, check that the `.env` file exists in the root.  

## Prebuilt images

Pre-built container images for all services can be downloaded from Microsoft's container registry:

```bash
docker pull mcr.microsoft.com/iot/opc-twin-service:latest
docker pull mcr.microsoft.com/iot/opc-registry-service:latest
docker pull mcr.microsoft.com/iot/opc-history-service:latest  
docker pull mcr.microsoft.com/iot/opc-onboarding-service:latest  
docker pull mcr.microsoft.com/iot/opc-gateway-service:latest
```

They can be deployed in container services such as Azure Container services (AKS).

## Next steps

- Develop an Application that reads and writes Variables in an OPC UA Server (COMING SOON)